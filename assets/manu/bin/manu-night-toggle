#!/bin/bash

#    ┓┏┓┏┏┓┳┓┏┓┳┳┳┓┏┓┏┓┏┳┓  ┏┓┏┓┳┓┳┏┓┏┳┓
#    ┣┫┗┫┃┃┣┫┗┓┃┃┃┃┗┓┣  ┃   ┗┓┃ ┣┫┃┃┃ ┃
#    ┛┗┗┛┣┛┛┗┗┛┗┛┛┗┗┛┗┛ ┻   ┗┛┗┛┛┗┻┣┛ ┻
#                               

# Temperature value when the nightlight is enabled
ON_TEMP=3300

# Current nightlight state maintained in toggles directory
STATE_FILE=~/.local/state/manu/toggles/nightlight-enabled

# Ensure the state directory exists
mkdir -p "$(dirname "$STATE_FILE")"

# Ensure hyprsunset is running
if ! pgrep -x hyprsunset; then
  # If hyprsunset is not running, the nightlight must be off. Clean up
  # any state that might remain from the user's last session.
  if [[ -f $STATE_FILE ]]; then
    rm $STATE_FILE
  fi

  setsid uwsm-app -- hyprsunset &
  sleep 1 # Give it time to register
fi

restart_nightlighted_waybar() {
  if grep -q "custom/nightlight" ~/.config/waybar/config.jsonc; then
    omarchy-restart-waybar # restart waybar in case user has waybar module for hyprsunset
  fi
}

if [[ -f $STATE_FILE ]]; then
  hyprctl hyprsunset identity
  rm $STATE_FILE
  notify-send "   Daylight screen temperature"
  restart_nightlighted_waybar
else
  hyprctl hyprsunset temperature $ON_TEMP
  touch $STATE_FILE
  notify-send "  Nightlight screen temperature"
  restart_nightlighted_waybar
fi
