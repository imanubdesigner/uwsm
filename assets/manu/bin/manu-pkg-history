#!/bin/zsh

#      ┓     ┓┏┳┏┓┏┳┓┏┓┳┓┓┏
#    ┏┓┃┏┏┓  ┣┫┃┗┓ ┃ ┃┃┣┫┗┫
#    ┣┛┛┗┗┫  ┛┗┻┗┛ ┻ ┗┛┛┗┗┛
#    ┛    ┛         

fetch_events() {
    local limit=$1
    grep -E "installed|upgraded|removed" /var/log/pacman.log | tail -n "$limit" | while read -r line; do
        date_time=$(echo "$line" | awk '{print $1, $2}' | tr -d '[]')
        action=$(echo "$line" | awk '{print $3}')
        package=$(echo "$line" | cut -d' ' -f4-)

        case "$action" in
            installed)
                icon=""
                color="#A6E3A1"
                ;;
            upgraded)
                icon=""
                color="#89B4FA"
                ;;
            removed)
                icon=""
                color="#F28FAD"
                ;;
            *)
                icon=""
                color="#F5E0DC"
                ;;
        esac

        gum style --foreground "$color" <<< "$date_time $icon $package"
    done
}

# ── Title box ────────────────────────────────────────────────────────────────
gum style \
  --border normal \
  --border-foreground "#89B4FA" \
  --foreground "#89B4FA" \
  --bold \
  --align center \
  --width 60 \
  "  Recent Pacman Package Events"

# ── Legend ───────────────────────────────────────────────────────────────────
gum style --align center --width 60 <<EOF
$(gum style --foreground "#A6E3A1" " installed")   \
$(gum style --foreground "#89B4FA" " upgraded")   \
$(gum style --foreground "#F28FAD" " removed")
EOF

# ── Menu ─────────────────────────────────────────────────────────────────────
choice=$(gum choose \
  "󰈙  Show last 10 events" \
  "󰈚  Show last 20 events" \
  "󰆍  Show last 50 events" \
  "  Exit")

case "$choice" in
    "󰈙  Show last 10 events") limit=10 ;;
    "󰈚  Show last 20 events") limit=20 ;;
    "󰆍  Show last 50 events") limit=50 ;;
    "  Exit") exit 0 ;;
    *) exit 0 ;;
esac

# ── Output ───────────────────────────────────────────────────────────────────
fetch_events "$limit"

