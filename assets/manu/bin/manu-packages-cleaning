#!/bin/bash

#    â”â”“â”â”“â”â”“â”“â”â”“â”â”“â”â”“â”â”“â”â”“  â”â”“â”“ â”â”“â”â”“â”³â”“â”â”“â”³â”“
#    â”ƒâ”ƒâ”£â”«â”ƒ â”ƒâ”« â”£â”«â”ƒâ”“â”£ â”—â”“  â”ƒ â”ƒ â”£ â”£â”«â”ƒâ”ƒâ”£ â”£â”«
#    â”£â”›â”›â”—â”—â”›â”›â”—â”›â”›â”—â”—â”›â”—â”›â”—â”›  â”—â”›â”—â”›â”—â”›â”›â”—â”›â”—â”—â”›â”›â”—
#                              by Manu

# ============================================================================
#  ó°£‡ Pacman & Yay Cache Cleaner
#  Interactive cache cleaner with Catppuccin Mocha (Blue Accent)
# ============================================================================

# Catppuccin Mocha color palette (blue focused)
export GUM_CHOOSE_CURSOR_FOREGROUND="#f5e0dc"
export GUM_CHOOSE_SELECTED_FOREGROUND="#cba6f7"
export GUM_CHOOSE_HEADER_FOREGROUND="#89b4fa"
export GUM_CONFIRM_PROMPT_FOREGROUND="#f5e0dc"
export GUM_CONFIRM_SELECTED_FOREGROUND="#89dceb"
export GUM_CONFIRM_UNSELECTED_FOREGROUND="#89b4fa"
# Removed GUM_SPIN colors to enforce direct command execution and prevent deadlocks

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£œ  Check for gum
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v gum &>/dev/null; then
  echo "ó°…–  Error: gum is required. Please install it (e.g., yay -S gum)."
  exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”‘ Keep sudo active
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
check_sudo() {
  gum style \
    --foreground="#89b4fa" \
    --margin="1 0" \
    "ó°›  Checking sudo privileges..."

  # Check if sudo token exists or prompt for password
  if ! sudo -v &>/dev/null; then
    gum style \
      --foreground="#f38ba8" \
      --bold \
      "ó°…–  Failed to obtain sudo privileges. Exiting..."
    exit 1
  fi

  # Keep sudo token active in the background
  while true; do
    sudo -n true
    sleep 50
    kill -0 "$$" || exit
  done 2>/dev/null &
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£– Display Header
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_header() {
  gum style \
    --foreground="#89b4fa" \
    --border="rounded" \
    --border-foreground="#89dceb" \
    --padding="1 2" \
    --margin="1" \
    "ó°£‡  Pacman & Yay Cache Cleaner" \
    "" \
    "   Clean package manager caches and free disk space"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°” Cache Size Utilities
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_cache_size_bytes() {
  local path=$1
  [ -d "$path" ] && du -sb "$path" 2>/dev/null | cut -f1 || echo "0"
}

bytes_to_human() {
  local bytes=$1
  if [ "$bytes" -eq 0 ]; then
    echo "0 B"
  else
    # Use numfmt for clean human-readable output (preferred over basic shell loop)
    numfmt --to=iec-i --suffix=B "$bytes" 2>/dev/null || echo "${bytes} B"
  fi
}

check_cache_size() {
  local pacman_cache=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
  local yay_cache=""
  [ -d "$HOME/.cache/yay" ] && yay_cache=$(du -sh "$HOME/.cache/yay" 2>/dev/null | cut -f1)

  gum style \
    --foreground="#89dceb" \
    --margin="1 0" \
    "ó°”  Current cache sizes:" \
    "   ó°®¯  Pacman:  $pacman_cache" \
    "   ó°š°  Yay:     ${yay_cache:-Not found}"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°„¬  Pacman Cleaner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean_pacman() {
  local option=$1
  local size_before=$(get_cache_size_bytes "/var/cache/pacman/pkg")
  local success=0

  # CRITICAL FIX: Check and remove Pacman lock file to prevent "unable to lock database" error
  if [ -f /var/lib/pacman/db.lck ]; then
    gum style --foreground="#ed8796" "ó°Žº  Found Pacman lock file (db.lck). Removing..."
    sudo rm /var/lib/pacman/db.lck
    gum style --foreground="#94e2d5" "ó°Žº  Lock file removed. Continuing cleanup."
  fi

  case $option in
  "Keep last 3 versions")
    # Paccache non Ã¨ interattivo, l'esecuzione diretta dovrebbe funzionare.
    gum spin --title "ó°®¯  Cleaning pacman cache (keep last 3 versions)..." -- sudo paccache -r
    success=$?
    ;;
  "Keep last version only")
    # Paccache non Ã¨ interattivo, l'esecuzione diretta dovrebbe funzionare.
    gum spin --title "ó°®¯  Cleaning pacman cache (keep last version)..." -- sudo paccache -rk1
    success=$?
    ;;
  "Remove all cached packages")
    if gum confirm --default=false "ó°—¡  Remove ALL cached pacman packages?"; then
      # CORREZIONE FINALE: Forziamo l'input 'y' per rispondere a tutte le
      # domande interattive di pacman -Scc (rimuovere repo non usati e tutti i file).
      # Usiamo 'yes |' come nell'originale ma con 'y' per le risposte affermative.
      gum spin --title "ó°®¯  Removing all cached packages..." -- bash -c 'yes y | sudo pacman -Scc'
      success=$?
    else
      gum style --foreground="#89b4fa" "   â†³  Skipped"
      return
    fi
    ;;
  esac

  # Success/Error reporting
  if [ "$success" -eq 0 ]; then
    local size_after=$(get_cache_size_bytes "/var/cache/pacman/pkg")
    local freed=$((size_before - size_after))
    local freed_human=$(bytes_to_human $freed)

    gum style --foreground="#94e2d5" "ó°„¬  Pacman cache cleaned successfully!"
    gum style --foreground="#89dceb" --bold "   ó°Œª  Space freed: $freed_human"
  else
    gum style --foreground="#ed8796" "ó°…™  Error (Code $success) during Pacman cleanup. Check terminal output."
  fi
  echo ""
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°š°  Yay Cleaner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean_yay() {
  if ! command -v yay &>/dev/null; then
    gum style --foreground="#89b4fa" "ó°šŒ  Yay not installed. Skipping..."
    return
  fi

  local option=$1
  local size_before=$(get_cache_size_bytes "$HOME/.cache/yay")
  local success=0

  case $option in
  "Remove uninstalled packages")
    gum confirm --default=false "ó°—¡  Remove uninstalled AUR packages cache?" && {
      # Execute directly with --noconfirm
      gum style --foreground="#89b4fa" "ó°š°  Executing: Removing uninstalled packages cache (yay -Sc --noconfirm)..."
      yay -Sc --noconfirm
      success=$?
    }
    ;;
  "Remove all cached packages")
    if gum confirm --default=false "ó°—¡  Remove ALL AUR package cache?"; then
      # Execute directly with --noconfirm
      gum style --foreground="#89b4fa" "ó°š°  Executing: Removing all packages cache (yay -Scc --noconfirm)..."
      yay -Scc --noconfirm
      success=$?
    else
      gum style --foreground="#89b4fa" "   â†³  Skipped"
      return
    fi
    ;;
  esac

  if [ "$success" -eq 0 ]; then
    local size_after=$(get_cache_size_bytes "$HOME/.cache/yay")
    local freed=$((size_before - size_after))
    local freed_human=$(bytes_to_human $freed)

    gum style --foreground="#94e2d5" "ó°„¬  Yay cache cleaned successfully!"
    gum style --foreground="#89dceb" --bold "   ó°Œª  Space freed: $freed_human"
  else
    gum style --foreground="#ed8796" "ó°…™  Error (Code $success) during Yay cleanup. Check terminal output."
  fi
  echo ""
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£‡  Main Menu
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main() {
  clear
  check_sudo
  show_header
  check_cache_size

  while true; do
    CLEAN_CHOICE=$(gum choose --header="ó°£‡  What would you like to clean?" \
      "Pacman cache" \
      "Yay cache" \
      "Both" \
      "Exit")

    case $CLEAN_CHOICE in
    "Pacman cache")
      PACMAN_OPTION=$(gum choose --header="ó°®¯  Select cleaning method:" \
        "Keep last 3 versions" \
        "Keep last version only" \
        "Remove all cached packages")
      clean_pacman "$PACMAN_OPTION"
      ;;
    "Yay cache")
      YAY_OPTION=$(gum choose --header="ó°š°  Select cleaning method:" \
        "Remove uninstalled packages" \
        "Remove all cached packages")
      clean_yay "$YAY_OPTION"
      ;;
    "Both")
      PACMAN_OPTION=$(gum choose --header="ó°®¯  Pacman cleaning method:" \
        "Keep last 3 versions" \
        "Keep last version only" \
        "Remove all cached packages")
      clean_pacman "$PACMAN_OPTION"

      echo ""
      YAY_OPTION=$(gum choose --header="ó°š°  Yay cleaning method:" \
        "Remove uninstalled packages" \
        "Remove all cached packages")
      clean_yay "$YAY_OPTION"
      ;;
    "Exit")
      gum style --foreground="#89b4fa" "ó°…–  Goodbye!"
      # Kill the background sudo process
      kill $(jobs -p) 2>/dev/null
      exit 0
      ;;
    esac

    check_cache_size
    echo ""

    # Ask if the user wants to clean something else
    gum confirm "ó°„¬  Clean something else?" || break
  done

  gum style --foreground="#94e2d5" --bold "ó°„›  All done! Stay frosty â„ï¸"
  # Kill the background sudo process
  kill $(jobs -p) 2>/dev/null
}

# Run the main function
main
