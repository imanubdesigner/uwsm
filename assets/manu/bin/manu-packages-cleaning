#!/bin/bash

#    â”â”“â”â”“â”â”“â”“â”â”“â”â”“â”â”“â”â”“â”â”“  â”â”“â”“ â”â”“â”â”“â”³â”“â”â”“â”³â”“
#    â”ƒâ”ƒâ”£â”«â”ƒ â”ƒâ”« â”£â”«â”ƒâ”“â”£ â”—â”“  â”ƒ â”ƒ â”£ â”£â”«â”ƒâ”ƒâ”£ â”£â”«
#    â”£â”›â”›â”—â”—â”›â”›â”—â”›â”›â”—â”—â”›â”—â”›â”—â”›  â”—â”›â”—â”›â”—â”›â”›â”—â”›â”—â”—â”›â”›â”—
#                              

# ============================================================================
#  ó°£‡ Pacman & Yay Cache Cleaner
#  Interactive cache cleaner with Catppuccin Mocha (Blue Accent)
# ============================================================================

# Catppuccin Mocha color palette (blue focused)
export GUM_CHOOSE_CURSOR_FOREGROUND="#f5e0dc"
export GUM_CHOOSE_SELECTED_FOREGROUND="#cba6f7"
export GUM_CHOOSE_HEADER_FOREGROUND="#89b4fa"
export GUM_CONFIRM_PROMPT_FOREGROUND="#f5e0dc"
export GUM_CONFIRM_SELECTED_FOREGROUND="#89dceb"
export GUM_CONFIRM_UNSELECTED_FOREGROUND="#89b4fa"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£œ  Check for gum
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v gum &>/dev/null; then
  echo "ó°…–  Error: gum is required. Please install it (e.g., yay -S gum)."
  exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”‘ Keep sudo active
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
check_sudo() {
  gum style \
    --foreground="#89b4fa" \
    --margin="1 0" \
    "ó°›  Checking sudo privileges..."

  # Check if sudo token exists or prompt for password
  if ! sudo -v &>/dev/null; then
    gum style \
      --foreground="#f38ba8" \
      --bold \
      "ó°…–  Failed to obtain sudo privileges. Exiting..."
    exit 1
  fi

  # Keep sudo token active in the background
  while true; do
    sudo -n true
    sleep 50
    kill -0 "$$" || exit
  done 2>/dev/null &
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£– Display Header
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_header() {
  gum style \
    --foreground="#89b4fa" \
    --border="rounded" \
    --border-foreground="#89dceb" \
    --padding="1 2" \
    --margin="1" \
    "ó°£‡  Pacman & Yay Cache Cleaner" \
    "" \
    "   Clean package manager caches and free disk space"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°” Cache Size Utilities
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_cache_size_bytes() {
  local path=$1
  [ -d "$path" ] && du -sb "$path" 2>/dev/null | cut -f1 || echo "0"
}

bytes_to_human() {
  local bytes=$1
  if [ "$bytes" -eq 0 ]; then
    echo "0 B"
  else
    numfmt --to=iec-i --suffix=B "$bytes" 2>/dev/null || echo "${bytes} B"
  fi
}

check_cache_size() {
  local pacman_cache=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
  local yay_cache=""
  [ -d "$HOME/.cache/yay" ] && yay_cache=$(du -sh "$HOME/.cache/yay" 2>/dev/null | cut -f1)

  gum style \
    --foreground="#89dceb" \
    --margin="1 0" \
    "ó°”  Current cache sizes:" \
    "   ó°®¯  Pacman:  $pacman_cache" \
    "   ó°š°  Yay:     ${yay_cache:-Not found}"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°„¬  Pacman Cleaner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean_pacman() {
  local option=$1
  local size_before=$(get_cache_size_bytes "/var/cache/pacman/pkg")
  local success=0

  # Check and remove Pacman lock file to prevent "unable to lock database" error
  if [ -f /var/lib/pacman/db.lck ]; then
    gum style --foreground="#ed8796" "ó°Žº  Found Pacman lock file (db.lck). Removing..."
    sudo rm /var/lib/pacman/db.lck
    gum style --foreground="#94e2d5" "ó°Žº  Lock file removed. Continuing cleanup."
  fi

  case $option in
  "Keep last 3 versions")
    gum spin --title "ó°®¯  Cleaning pacman cache (keep last 3 versions)..." -- sudo paccache -r
    success=$?
    ;;
  "Keep last version only")
    gum spin --title "ó°®¯  Cleaning pacman cache (keep last version)..." -- sudo paccache -rk1
    success=$?
    ;;
  "Remove all cached packages")
    if gum confirm --default=false "ó°—¡  Remove ALL cached pacman packages?"; then
      # Check if cache is empty
      local pkg_count=$(find /var/cache/pacman/pkg -name "*.pkg.tar*" 2>/dev/null | wc -l)

      if [ "$pkg_count" -eq 0 ]; then
        gum style --foreground="#89b4fa" "   â†³  Cache already empty, nothing to remove"
        return
      fi

      gum style --foreground="#89b4fa" "ó°®¯  Removing all cached packages..."

      # Run pacman -Scc and capture output/errors separately
      yes y | sudo pacman -Scc >/tmp/pacman_clean.log 2>&1
      success=${PIPESTATUS[1]}

      # Clean up temporary download directories AFTER pacman runs
      sudo find /var/cache/pacman/pkg -type d -name "download-*" -exec rm -rf {} + 2>/dev/null

      # Check if cache was actually cleaned
      local pkg_count_after=$(find /var/cache/pacman/pkg -name "*.pkg.tar*" 2>/dev/null | wc -l)

      if [ "$pkg_count_after" -eq 0 ]; then
        # Cache is empty = success, ignore error 253
        success=0
        gum style --foreground="#94e2d5" "ó°®¯  All cached packages removed successfully"
      else
        # Cache still has files = real error
        gum style --foreground="#ed8796" "ó°…™  Failed to clean cache completely. Check /tmp/pacman_clean.log"
      fi
    else
      gum style --foreground="#89b4fa" "   â†³  Skipped"
      return
    fi
    ;;
  esac

  # Success/Error reporting
  if [ "$success" -eq 0 ]; then
    local size_after=$(get_cache_size_bytes "/var/cache/pacman/pkg")
    local freed=$((size_before - size_after))
    local freed_human=$(bytes_to_human $freed)

    gum style --foreground="#94e2d5" "ó°„¬  Pacman cache cleaned successfully!"
    gum style --foreground="#89dceb" --bold "   ó°Œª  Space freed: $freed_human"
  else
    gum style --foreground="#ed8796" "ó°…™  Error (Code $success) during Pacman cleanup."
  fi
  echo ""
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°š°  Yay Cleaner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean_yay() {
  if ! command -v yay &>/dev/null; then
    gum style --foreground="#89b4fa" "ó°šŒ  Yay not installed. Skipping..."
    return
  fi

  local option=$1
  local size_before=$(get_cache_size_bytes "$HOME/.cache/yay")
  local success=0

  case $option in
  "Remove uninstalled packages")
    if gum confirm --default=false "ó°—¡  Remove uninstalled AUR packages cache?"; then
      gum style --foreground="#89b4fa" "ó°š°  Removing uninstalled packages cache..."
      yes | yay -Sc 2>&1 | tee /tmp/yay_clean.log
      success=${PIPESTATUS[1]}

      if [ "$success" -ne 0 ]; then
        gum style --foreground="#ed8796" "ó°…™  Yay returned code $success. Log saved to /tmp/yay_clean.log"
      fi
    else
      gum style --foreground="#89b4fa" "   â†³  Skipped"
      return
    fi
    ;;
  "Remove all cached packages")
    if gum confirm --default=false "ó°—¡  Remove ALL AUR package cache?"; then
      gum style --foreground="#89b4fa" "ó°š°  Removing all packages cache..."

      # Run yay -Scc and capture output/errors separately
      yes | yay -Scc >/tmp/yay_clean.log 2>&1
      success=${PIPESTATUS[1]}

      # Clean up temporary download directories AFTER yay runs
      if [ -d "$HOME/.cache/yay" ]; then
        find "$HOME/.cache/yay" -type d -name "download-*" -exec rm -rf {} + 2>/dev/null
      fi

      # Check if yay cache was actually cleaned
      local remaining_pkgs=0
      if [ -d "$HOME/.cache/yay" ]; then
        remaining_pkgs=$(find "$HOME/.cache/yay" -name "*.pkg.tar*" 2>/dev/null | wc -l)
      fi

      if [ "$remaining_pkgs" -eq 0 ]; then
        # Cache is empty = success, ignore error 253
        success=0
        gum style --foreground="#94e2d5" "ó°š°  All cached packages removed successfully"
      else
        # Cache still has files = real error
        gum style --foreground="#ed8796" "ó°…™  Failed to clean cache completely. Check /tmp/yay_clean.log"
      fi
    else
      gum style --foreground="#89b4fa" "   â†³  Skipped"
      return
    fi
    ;;
  esac

  if [ "$success" -eq 0 ]; then
    local size_after=$(get_cache_size_bytes "$HOME/.cache/yay")
    local freed=$((size_before - size_after))
    local freed_human=$(bytes_to_human $freed)

    gum style --foreground="#94e2d5" "ó°„¬  Yay cache cleaned successfully!"
    gum style --foreground="#89dceb" --bold "   ó°Œª  Space freed: $freed_human"
  else
    gum style --foreground="#ed8796" "ó°…™  Error (Code $success) during Yay cleanup."
  fi
  echo ""
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ó°£‡  Main Menu
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main() {
  check_sudo
  show_header
  check_cache_size

  while true; do
    CLEAN_CHOICE=$(gum choose --header="ó°£‡  What would you like to clean?" \
      "Pacman cache" \
      "Yay cache" \
      "Both" \
      "Exit")

    case $CLEAN_CHOICE in
    "Pacman cache")
      PACMAN_OPTION=$(gum choose --header="ó°®¯  Select cleaning method:" \
        "Keep last 3 versions" \
        "Keep last version only" \
        "Remove all cached packages")
      clean_pacman "$PACMAN_OPTION"
      ;;
    "Yay cache")
      YAY_OPTION=$(gum choose --header="ó°š°  Select cleaning method:" \
        "Remove uninstalled packages" \
        "Remove all cached packages")
      clean_yay "$YAY_OPTION"
      ;;
    "Both")
      PACMAN_OPTION=$(gum choose --header="ó°®¯  Pacman cleaning method:" \
        "Keep last 3 versions" \
        "Keep last version only" \
        "Remove all cached packages")
      clean_pacman "$PACMAN_OPTION"

      echo ""
      YAY_OPTION=$(gum choose --header="ó°š°  Yay cleaning method:" \
        "Remove uninstalled packages" \
        "Remove all cached packages")
      clean_yay "$YAY_OPTION"
      ;;
    "Exit")
      gum style --foreground="#89b4fa" "ó°…–  Goodbye!"
      # Kill the background sudo process
      kill $(jobs -p) 2>/dev/null
      exit 0
      ;;
    esac

    check_cache_size
    echo ""

    # Ask if the user wants to clean something else
    gum confirm "ó°„¬  Clean something else?" || break
  done

  gum style --foreground="#94e2d5" --bold "ó°„›  All done! Stay frosty â„ï¸"
  # Kill the background sudo process
  kill $(jobs -p) 2>/dev/null
}

# Run the main function
main
