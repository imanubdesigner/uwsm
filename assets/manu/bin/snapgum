#!/usr/bin/env bash

# Configurations to manage
CONFIGS=("root" "home")

# Catppuccin colors
MAUVE="#cba6f7"
BLUE="#89b4fa"
GREEN="#a6e3a1"
RED="#f38ba8"
TEXT="#cdd6f4"
BASE="#1e1e2e"

clear

gum style \
  --foreground "$MAUVE" \
  --border foreground \
  --border-foreground "$BLUE" \
  --border rounded \
  --padding "1 2" \
  "󰁯  Full System Snapshot (Root & Home)"

# Input for snapshot description
SNAP_NAME=$(gum input \
  --placeholder "e.g. 󰏗 pre-upgrade | 󰍛 before-nvidia" \
  --prompt "󰘧 " \
  --prompt.foreground "$BLUE" \
  --cursor.foreground "$MAUVE")

if [[ -z "$SNAP_NAME" ]]; then
  gum style --foreground "$RED" "󰅙 Snapshot cancelled"
  exit 1
fi

# Loop through each configuration
for CONF in "${CONFIGS[@]}"; do
  gum style --foreground "$GREEN" "󰆓 Creating snapshot for $CONF: $SNAP_NAME"

  # Create the snapshot
  sudo snapper -c "$CONF" create \
    --description "$SNAP_NAME" \
    --cleanup-algorithm number

  # Identify the newly created ID
  NEW_ID=$(sudo snapper -c "$CONF" list | awk 'NR>3 {print $1}' | tail -n 1)
  gum style --foreground "$GREEN" "󰄬 $CONF snapshot created (ID $NEW_ID)"

  # Collect previous snapshots excluding the new one
  OLD_IDS=$(sudo snapper -c "$CONF" list | awk 'NR>3 {print $1}' | grep -v "^$NEW_ID$")

  if [[ -n "$OLD_IDS" ]]; then
    if gum confirm \
      --prompt.foreground "$BLUE" \
      --selected.background "$MAUVE" \
      --selected.foreground "$BASE" \
      --unselected.foreground "$TEXT" \
      "󰆴 Do you want to delete previous $CONF snapshots?"; then

      echo
      gum style --foreground "$TEXT" "󰈙 Snapshots that will be deleted ($CONF):"
      sudo snapper -c "$CONF" list | awk 'NR>3 {print}' | grep -v "^$NEW_ID"

      echo
      if gum confirm \
        --prompt.foreground "$RED" \
        --selected.background "$RED" \
        --selected.foreground "$BASE" \
        --unselected.foreground "$TEXT" \
        "󰇾 Are you sure you want to delete them?"; then

        for id in $OLD_IDS; do
          sudo snapper -c "$CONF" delete "$id"
        done

        gum style --foreground "$GREEN" "󰆴 Old $CONF snapshots deleted"
      else
        gum style --foreground "$TEXT" "󰆒 No $CONF snapshots deleted"
      fi
    else
      gum style --foreground "$TEXT" "󰆒 $CONF snapshots kept"
    fi
  else
    gum style --foreground "$TEXT" "󰆒 No previous snapshots for $CONF"
  fi
  echo "------------------------------------------------"
done

echo
gum style --foreground "$MAUVE" "󰄬 All operations completed"
