#!/bin/bash

#  ┓ ┏┏┓  ┳┓┏┓┏┓┏┓┳┓┳┓┏┓┳┓
#  ┃┃┃┣ ━━┣┫┣ ┃ ┃┃┣┫┃┃┣ ┣┫
#  ┗┻┛┻   ┛┗┗┛┗┛┗┛┛┗┻┛┗┛┛┗
#                  by Manu

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}/screen-record"
mkdir -p "$OUTPUT_DIR"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  notify-send "  Directory not found" "Missing: $OUTPUT_DIR" -u critical -t 3000
  exit 1
fi

SCOPE=""
AUDIO="false"

for arg in "$@"; do
  case "$arg" in
  --with-audio) AUDIO="true" ;;
  output | region) SCOPE="$arg" ;;
  esac
done

MIC_SOURCE="alsa_input.usb-Samson_Technologies_Samson_Meteor_Mic-00.analog-stereo"
SYS_SOURCE="default_output"

toggle_screenrecording_indicator() { pkill -RTMIN+8 waybar; }
screenrecording_active() { pgrep -f "gpu-screen-recorder" >/dev/null; }

start_screenrecording() {
  local filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
  local audio_args=""
  [[ "$AUDIO" == "true" ]] && audio_args="-a $SYS_SOURCE|$MIC_SOURCE"

  notify-send "󰍹  Recording started" "Mode: $SCOPE | Audio: $AUDIO" -t 1200
  gpu-screen-recorder -w "$@" -f 60 -c mp4 -o "$filename" $audio_args &
  toggle_screenrecording_indicator
}

stop_screenrecording() {
  pkill -SIGINT -f "gpu-screen-recorder"
  sleep 0.5
  if pgrep -f "gpu-screen-recorder" >/dev/null; then
    pkill -9 -f "gpu-screen-recorder"
    notify-send "  Recording error" "Force-stopped (file may be corrupted)." -u critical
  else
    notify-send "󰄴  Recording saved" "Saved in: $OUTPUT_DIR" -t 2000
  fi
  toggle_screenrecording_indicator
}

# --- main ---
if screenrecording_active; then
  stop_screenrecording
  exit 0
fi

if [[ "$SCOPE" == "output" ]]; then
  output=$(slurp -o -f "%o") || exit 1
  [[ -z "$output" ]] && {
    notify-send "  Error" "Could not detect monitor output." -u critical
    exit 1
  }
  start_screenrecording "$output"
else
  region=$(slurp -f "%wx%h+%x+%y") || exit 1
  start_screenrecording region -region "$region"
fi
