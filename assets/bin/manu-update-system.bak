#!/bin/bash

#    ┳┳┏┓┳┓┏┓┏┳┓┏┓  ┏┓┓┏┏┓┏┳┓┏┓┳┳┓
#    ┃┃┃┃┃┃┣┫ ┃ ┣   ┗┓┗┫┗┓ ┃ ┣ ┃┃┃
#    ┗┛┣┛┻┛┛┗ ┻ ┗┛  ┗┛┗┛┗┛ ┻ ┗┛┛ ┗
#            ┏┓┏┓┳┓┳┏┓┏┳┓
#            ┗┓┃ ┣┫┃┃┃ ┃
#            ┗┛┗┛┛┗┻┣┛ ┻
#                        by Manu 

#   update-system: update system packages (only pacman) on Arch Linux

# If no terminal is open, open it automatically
if [ ! -t 1 ]; then
  exec uwsm-app -- $TERMINAL --class=PkgUpdate -e bash "$0" "$@"
fi

# Command
PACMAN="sudo pacman -Syu"

# Colors
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

# Functions
print_info() {
  printf "%b\n" "${YELLOW}󰣇  [$(date '+%H:%M:%S')] $1${RESET}"
}

print_ok() {
  echo -e "${GREEN}󰄬  $1${RESET}"
}

print_err() {
  echo -e "${RED}󰅚  $1${RESET}"
}

# ────────────────────────────────────────────────
#   Start update
# ────────────────────────────────────────────────
print_info "  Starting system update..."
notify-send "  System update" "󰏔  Starting update..." -a "Update Script"

print_info "󰏔  Updating official packages..."
if $PACMAN; then
  print_ok "󰄳  Pacman update completed."
  notify-send "  System update" "󰄳  All packages are up to date." -a "Update Script"
else
  print_err "󰅚  Pacman update failed."
  notify-send "  System update" "󰅚  Update failed!" -a "Update Script" -u critical
  exit 1
fi

# ────────────────────────────────────────────────
#   Kernel update check (post-update)
# ────────────────────────────────────────────────
if tail -n 20 /var/log/pacman.log | grep -qE "upgraded linux(-[a-z0-9]+)? "; then
  echo ""
  notify-send "  Kernel update detected" "  It's recommended to reboot your system." -a "Update Script"

  gum style \
    --border double \
    --border-foreground 111 \
    --margin "1 2" \
    --padding "1 2" \
    "  Linux kernel update detected!" \
    "  It's recommended to reboot your system to apply changes." \
    "󰜉  Would you like to reboot now?"

  echo ""
  choice=$(gum choose \
    --cursor.foreground=33 \
    --height=2 \
    "󰜱  Yes, reboot now" \
    "󰜺  No, later")

  if [[ "$choice" == "󰜱  Yes, reboot now" ]]; then
    gum confirm "󰜉  Confirm reboot now?" && systemctl reboot
  else
    gum style --foreground 245 "󰒤  Remember to reboot later."
    notify-send "  Reboot postponed" "󰒤  Remember to reboot later." -a "Update Script"
  fi
fi

# Waybar cache update
sleep 0.5
print_info "󰩹  Clearing Waybar update cache..."
rm -f /tmp/waybar-updates-cache 2>/dev/null
pkill -SIGRTMIN+8 waybar 2>/dev/null
print_ok "󰩹  Waybar cache cleared and refreshed."

# ────────────────────────────────────────────────
