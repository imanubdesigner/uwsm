#!/bin/bash

COMMAND="$1"

if [[ -z $COMMAND ]]; then
  echo "Usage: snapper-snapshot <create|restore>" >&2
  exit 1
fi

if ! command -v snapper &>/dev/null; then
  echo "Snapper not found. Please install it first." >&2
  exit 127
fi

if ! command -v limine-snapper-restore &>/dev/null; then
  echo "limine-snapper-restore not found. Please install 'limine-snapper-sync'." >&2
  exit 127
fi

case "$COMMAND" in
create)
  DESC="System snapshot"

  echo -e "\e[32mCreating system snapshot\e[0m"

  # Get existing snapper config names from CSV output
  mapfile -t CONFIGS < <(sudo snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')

  for config in "${CONFIGS[@]}"; do
    sudo snapper -c "$config" create -c number -d "$DESC"
  done
  echo "Snapshot created successfully!"
  ;;
restore)
  echo -e "\e[33mRestoring snapshot using limine-snapper-restore\e[0m"
  sudo limine-snapper-restore
  ;;
*)
  echo "Invalid command. Use 'create' or 'restore'."
  exit 1
  ;;
esac

